# üå∏ MCP Agent Integration Guide

**Complete integration between Unity and all 10 Model Context Protocol servers**

---

## Overview

The `MCPAgent` provides intelligent automation for the BambiSleep‚Ñ¢ CatGirl Avatar System by integrating Unity with 10 MCP servers. This enables AI-powered development workflows, automated testing, version control, and intelligent decision-making directly from Unity.

### 10 MCP Servers Integrated

1. **Filesystem** - Asset management and file operations
2. **Git** - Version control with emoji conventions
3. **GitHub** - Issue tracking, PRs, and collaboration
4. **Memory** - Knowledge graph for context persistence
5. **Sequential Thinking** - Complex problem solving
6. **Everything** - Diagnostics and testing
7. **Brave Search** - Unity API documentation search
8. **Postgres** - Player data persistence
9. **Stripe** - Payment processing and economy
10. **Fetch** - External API integration

---

## Setup

### 1. Add MCPAgent to Scene

```csharp
// Create empty GameObject in scene
GameObject mcpAgentObj = new GameObject("MCP Agent");
MCPAgent agent = mcpAgentObj.AddComponent<MCPAgent>();
agent.ipcBridge = FindObjectOfType<IPCBridge>();
```

### 2. Configure MCP Servers

In Unity Inspector:
- ‚úÖ Enable desired MCP servers
- ‚öôÔ∏è Set `maxConcurrentOps` (default: 5)
- üì¶ Enable `cacheResponses` for performance
- üîÑ Enable `batchRequests` for efficiency

### 3. Verify IPC Bridge Connection

The agent requires `IPCBridge` to communicate with Node.js MCP servers:

```bash
# Start Node.js bridge
cd /mnt/f/bambisleep-chat-catgirl
npm start
```

---

## Usage Examples

### üå∏ Filesystem Operations

```csharp
// Read Unity asset
MCPAgent.Instance.ReadAssetFile("Assets/Scripts/Character/CatgirlController.cs", content =>
{
    Debug.Log($"Read {content.Length} characters");
});

// Write generated content
string generatedCode = "// Auto-generated by MCP Agent";
MCPAgent.Instance.WriteAssetFile("Assets/Scripts/Generated/AutoBehavior.cs", generatedCode, success =>
{
    if (success) Debug.Log("‚úÖ File written");
});

// Search for prefabs
MCPAgent.Instance.SearchAssets("*.prefab", files =>
{
    Debug.Log($"Found {files.Count} prefabs");
});
```

### üêÑ Git Operations

```csharp
// Commit with emoji convention
MCPAgent.Instance.CommitChanges("ü¶ã", "Add butterfly flight feature", 
    new List<string> { "Assets/Scripts/Character/" }, success =>
{
    if (success) Debug.Log("‚úÖ Committed with ü¶ã emoji");
});

// Get git status
MCPAgent.Instance.GetGitStatus(status =>
{
    int modified = (int)status["modified"];
    int staged = (int)status["staged"];
    Debug.Log($"Modified: {modified}, Staged: {staged}");
});

// Create feature branch
MCPAgent.Instance.CreateFeatureBranch("cow-powers-enhancement", success =>
{
    if (success) Debug.Log("üêÑ Created cow powers branch");
});
```

### üëë GitHub Integration

```csharp
// Create bug report
MCPAgent.Instance.CreateBugReport(
    "NetworkBehaviour sync issue in multiplayer", 
    "Players not seeing each other's animations correctly",
    new[] { "bug", "multiplayer", "networking" },
    issueUrl =>
    {
        Debug.Log($"Created issue: {issueUrl}");
    }
);

// Create pull request
MCPAgent.Instance.CreatePullRequest(
    "ü¶ã Add butterfly flight feature",
    "Complete implementation with network synchronization",
    "main",
    prUrl =>
    {
        Debug.Log($"Created PR: {prUrl}");
    }
);
```

### üíé Memory & Knowledge Graph

```csharp
// Record development observation
MCPAgent.Instance.RecordObservation(
    "Character Controller", 
    "Implemented double-jump with NetworkBehaviour sync",
    success =>
    {
        if (success) Debug.Log("üìù Observation recorded");
    }
);

// Query knowledge graph
MCPAgent.Instance.QueryKnowledge("multiplayer synchronization patterns", results =>
{
    foreach (var result in results)
    {
        Debug.Log($"Knowledge: {result}");
    }
});
```

### üß† Sequential Thinking

```csharp
// Solve complex architecture problem
MCPAgent.Instance.SolveComplexProblem(
    "How to implement cross-platform inventory sync with offline support?",
    solution =>
    {
        Debug.Log($"üß† Solution: {solution}");
    }
);
```

### üîç Unity Documentation Search

```csharp
// Search Unity docs for specific API
MCPAgent.Instance.SearchUnityDocs("NetworkBehaviour OnNetworkSpawn", results =>
{
    foreach (var docUrl in results)
    {
        Debug.Log($"üìö Doc: {docUrl}");
    }
});
```

### üí∞ Stripe Payment Integration

```csharp
// Setup player economy
MCPAgent.Instance.SetupPlayerEconomy("player@example.com", customerId =>
{
    Debug.Log($"‚úÖ Player economy setup: {customerId}");
    
    // Create payment for in-game purchase
    MCPAgent.Instance.CreatePayment(
        999,              // $9.99 in cents
        "usd",
        customerId,
        paymentId =>
        {
            Debug.Log($"üí∞ Payment created: {paymentId}");
        }
    );
});
```

### üóÑÔ∏è PostgreSQL Database

```csharp
// Save player data
var playerData = new Dictionary<string, object>
{
    { "level", 42 },
    { "pink_coins", 5000 },
    { "cow_tokens", 3 },
    { "inventory", new[] { "divine_cow_crown", "pink_aura_wings" } }
};

MCPAgent.Instance.SavePlayerData("player_123", playerData, success =>
{
    if (success) Debug.Log("üíæ Player data saved");
});

// Load player data
MCPAgent.Instance.LoadPlayerData("player_123", data =>
{
    int level = (int)data["level"];
    Debug.Log($"Player level: {level}");
});
```

### üåê External API Fetch

```csharp
// Fetch from external API
MCPAgent.Instance.FetchExternalAPI("https://api.unity.com/v1/stats", response =>
{
    Debug.Log($"API Response: {response}");
});
```

### üîß Diagnostics

```csharp
// Run full diagnostics
MCPAgent.Instance.RunDiagnostics(results =>
{
    bool healthy = (bool)results["system_healthy"];
    int fps = (int)results["fps"];
    Debug.Log($"System Health: {healthy}, FPS: {fps}");
});
```

---

## High-Level Automation Workflows

### Auto-Commit Feature Workflow

```csharp
// Triggered via Context Menu: "Auto-Commit Current Feature"
MCPAgent.Instance.AutoCommitFeature();

// This will:
// 1. Get git status
// 2. Record observation in knowledge graph
// 3. Commit with emoji convention
// 4. Create GitHub issue for testing
```

### Deploy Cow Powers Secret Feature

```csharp
// Triggered via Context Menu: "Deploy Cow Powers Feature"
MCPAgent.Instance.DeployCowPowersFeature();

// This will:
// 1. Use sequential thinking to validate deployment
// 2. Search Unity multiplayer docs
// 3. Create feature branch
// 4. Record deployment in knowledge graph
```

---

## Performance Optimization

### Request Batching

Enable `batchRequests` to queue MCP operations and execute them efficiently:

```csharp
agent.batchRequests = true;
agent.maxConcurrentOps = 5; // Max 5 simultaneous requests
```

### Response Caching

Enable `cacheResponses` to avoid redundant MCP calls:

```csharp
agent.cacheResponses = true;

// Clear cache when needed
agent.ClearCache();
```

### Monitor Performance

```csharp
// Check MCP agent status
agent.ShowMCPStatus();

// Output:
// üå∏ MCP Agent Status:
//   Filesystem: ‚úÖ
//   Git: ‚úÖ
//   GitHub: ‚úÖ
//   Memory: ‚úÖ
//   Sequential Thinking: ‚úÖ
//   Everything: ‚úÖ
//   Brave Search: ‚úÖ
//   Postgres: ‚úÖ
//   Stripe: ‚úÖ
//   Fetch: ‚úÖ
//   Active Operations: 2/5
//   Queued Requests: 3
//   Cached Responses: 15
```

---

## Architecture

### Request Flow

```
Unity MCPAgent ‚Üí IPCBridge ‚Üí Node.js ‚Üí MCP Server ‚Üí Response
      ‚Üì                                                  ‚Üì
  Callback                                         JSON Response
```

### Data Structures

**MCPRequest:**
```csharp
{
    "server": "github",
    "action": "create_issue",
    "data": "{\"title\":\"Bug report\", \"body\":\"Description\"}",
    "callback": response => { /* handle */ }
}
```

**MCPResponse:**
```csharp
{
    "success": true,
    "server": "github",
    "action": "create_issue",
    "data": "{\"url\":\"https://github.com/...\"}",
    "error": null
}
```

---

## Context Menu Debug Commands

Right-click `MCPAgent` in Inspector:

- **Show MCP Status** - Display all server statuses
- **Clear Response Cache** - Clear cached responses
- **Run Full Diagnostics** - Execute system health check
- **Auto-Commit Current Feature** - Automated feature commit workflow
- **Deploy Cow Powers Feature** - Automated deployment workflow

---

## Integration with Existing Systems

### CatgirlController Integration

```csharp
public class CatgirlController : NetworkBehaviour
{
    private void OnValidate()
    {
        // Record changes in knowledge graph
        MCPAgent.Instance?.RecordObservation(
            "CatgirlController",
            $"Validation at {DateTime.Now}"
        );
    }
}
```

### UniversalBankingSystem Integration

```csharp
public class UniversalBankingSystem : NetworkBehaviour
{
    public async void ProcessPayment(long amount, string currency)
    {
        // Use Stripe MCP for payment processing
        MCPAgent.Instance.CreatePayment(amount, currency, playerId, paymentId =>
        {
            // Award in-game currency
            AddCurrency("pink_coins", amount / 100);
        });
    }
}
```

### InventorySystem Integration

```csharp
public class InventorySystem : MonoBehaviour
{
    public void SaveInventoryToCloud()
    {
        var inventoryData = new Dictionary<string, object>
        {
            { "items", items },
            { "capacity", maxSlots }
        };
        
        // Save to Postgres via MCP
        MCPAgent.Instance.SavePlayerData(playerId, inventoryData, success =>
        {
            if (success) Debug.Log("üíæ Inventory saved to cloud");
        });
    }
}
```

---

## Troubleshooting

### Issue: "IPCBridge not found"

**Solution:**
```csharp
// Ensure IPCBridge exists in scene
GameObject ipcBridgeObj = new GameObject("IPC Bridge");
IPCBridge bridge = ipcBridgeObj.AddComponent<IPCBridge>();

// Assign to MCPAgent
MCPAgent.Instance.ipcBridge = bridge;
```

### Issue: MCP requests timing out

**Solution:**
```csharp
// Increase timeout or reduce concurrent operations
agent.maxConcurrentOps = 3; // Reduce from 5 to 3

// Check Node.js bridge is running
// Terminal: npm start
```

### Issue: High memory usage from cache

**Solution:**
```csharp
// Clear cache periodically
InvokeRepeating("ClearMCPCache", 300f, 300f); // Every 5 minutes

void ClearMCPCache()
{
    MCPAgent.Instance.ClearCache();
}
```

---

## Best Practices

1. **Always check `enableMCPAgent`** before using MCP features
2. **Use callbacks** for asynchronous operations
3. **Enable caching** for frequently accessed data
4. **Batch requests** when performing multiple operations
5. **Monitor performance** via `ShowMCPStatus()` in development
6. **Record observations** in knowledge graph for AI learning
7. **Use emoji conventions** for git commits (üå∏ü¶ãüíéüëëüêÑ)
8. **Test with mock responses** before enabling real MCP servers

---

## Future Enhancements

- [ ] WebSocket support for real-time MCP communication
- [ ] Automatic retry logic for failed requests
- [ ] Request prioritization system
- [ ] MCP server health monitoring
- [ ] Offline mode with request queuing
- [ ] Visual Studio Code extension integration
- [ ] Unity Editor window for MCP management
- [ ] Custom MCP server creation framework

---

## References

- **IPCBridge.cs** - Node.js ‚Üî Unity communication protocol
- **docs/DEBUGGING.md** - Complete debugging reference
- **docs/development/UNITY_SETUP_GUIDE.md** - Unity implementation patterns
- **.vscode/settings.json** - MCP server configurations
- **setup-mcp.sh** - MCP server installation script
